name: Deploy Infrastructure

# ─── Required GitHub Secrets ─────────────────────────────────────────────────
# AZURE_CREDENTIALS          — Service principal JSON (az ad sp create-for-rbac)
# AZURE_RESOURCE_GROUP       — Target resource group name
# POSTGRES_ADMIN_PASSWORD    — PostgreSQL admin password
# SESSION_SECRET             — iron-session encryption key (openssl rand -base64 32)
#
# ─── Required GitHub Variables (Settings → Secrets and variables → Variables) ─
# DOMAIN_NAME                — Custom domain (e.g. lezhiweng.com)
# STORAGE_ACCOUNT_NAME       — Globally unique, 3-24 lowercase alphanumeric
# SITE_URL                   — Public URL (e.g. https://lezhiweng.com)
# ALERT_EMAIL                — Email for Azure Monitor alert notifications
# ─────────────────────────────────────────────────────────────────────────────

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - what-if

jobs:
  infra:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep (what-if)
        if: inputs.action == 'what-if'
        run: |
          az deployment group what-if \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --template-file infra/main.bicep \
            --parameters \
              domainName='${{ vars.DOMAIN_NAME }}' \
              postgresAdminLogin='pgadmin' \
              postgresAdminPassword='${{ secrets.POSTGRES_ADMIN_PASSWORD }}' \
              sessionSecret='${{ secrets.SESSION_SECRET }}' \
              storageAccountName='${{ vars.STORAGE_ACCOUNT_NAME }}' \
              siteUrl='${{ vars.SITE_URL }}' \
              alertEmail='${{ vars.ALERT_EMAIL }}'

      - name: Deploy Bicep
        if: inputs.action == 'deploy'
        run: |
          az deployment group create \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --template-file infra/main.bicep \
            --parameters \
              domainName='${{ vars.DOMAIN_NAME }}' \
              postgresAdminLogin='pgadmin' \
              postgresAdminPassword='${{ secrets.POSTGRES_ADMIN_PASSWORD }}' \
              sessionSecret='${{ secrets.SESSION_SECRET }}' \
              storageAccountName='${{ vars.STORAGE_ACCOUNT_NAME }}' \
              siteUrl='${{ vars.SITE_URL }}' \
              alertEmail='${{ vars.ALERT_EMAIL }}' \
            --verbose

      - name: Show outputs
        if: inputs.action == 'deploy'
        run: |
          az deployment group show \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name main \
            --query properties.outputs

      - name: Configure custom domains
        if: inputs.action == 'deploy' && vars.DOMAIN_NAME != ''
        run: |
          DOMAIN="${{ vars.DOMAIN_NAME }}"
          RG="${{ secrets.AZURE_RESOURCE_GROUP }}"
          APP="boringblog-app"
          ENV="boringblog-env"

          # Check if custom domains are already bound with certs
          BOUND=$(az containerapp hostname list --name $APP --resource-group $RG \
            --query "[?bindingType=='SniEnabled']" -o tsv 2>/dev/null | wc -l)
          if [ "$BOUND" -ge 2 ]; then
            echo "Custom domains already configured with certs, skipping."
            exit 0
          fi

          echo "=== Step 1: Add hostnames without cert binding ==="
          az containerapp hostname add --name $APP --resource-group $RG --hostname "$DOMAIN" 2>/dev/null || true
          az containerapp hostname add --name $APP --resource-group $RG --hostname "www.$DOMAIN" 2>/dev/null || true

          echo "=== Step 2: Create managed certificates ==="
          az containerapp env certificate create \
            --name $ENV --resource-group $RG \
            --hostname "$DOMAIN" --validation-method HTTP 2>/dev/null || true
          az containerapp env certificate create \
            --name $ENV --resource-group $RG \
            --hostname "www.$DOMAIN" --validation-method CNAME 2>/dev/null || true

          echo "=== Step 3: Wait for certificates to provision (up to 5 min) ==="
          for i in $(seq 1 30); do
            APEX_STATE=$(az containerapp env certificate list --name $ENV --resource-group $RG \
              --query "[?properties.subjectName=='$DOMAIN'].properties.provisioningState" -o tsv | head -1)
            WWW_STATE=$(az containerapp env certificate list --name $ENV --resource-group $RG \
              --query "[?properties.subjectName=='www.$DOMAIN'].properties.provisioningState" -o tsv | head -1)
            echo "  Attempt $i/30: apex=$APEX_STATE, www=$WWW_STATE"
            if [ "$APEX_STATE" = "Succeeded" ] && [ "$WWW_STATE" = "Succeeded" ]; then
              echo "  Both certs ready!"
              break
            fi
            if [ "$APEX_STATE" = "Failed" ] || [ "$WWW_STATE" = "Failed" ]; then
              echo "  Warning: A cert failed. Check DNS records and re-run this workflow."
              break
            fi
            sleep 10
          done

          echo "=== Step 4: Bind certificates to hostnames ==="
          APEX_CERT=$(az containerapp env certificate list --name $ENV --resource-group $RG \
            --query "[?properties.subjectName=='$DOMAIN' && properties.provisioningState=='Succeeded'].id" -o tsv | head -1)
          WWW_CERT=$(az containerapp env certificate list --name $ENV --resource-group $RG \
            --query "[?properties.subjectName=='www.$DOMAIN' && properties.provisioningState=='Succeeded'].id" -o tsv | head -1)

          if [ -n "$APEX_CERT" ]; then
            az containerapp hostname bind --name $APP --resource-group $RG --hostname "$DOMAIN" --certificate "$APEX_CERT" || true
            echo "  Bound $DOMAIN"
          else
            echo "  Warning: Apex cert not ready — re-run this workflow after DNS propagates"
          fi

          if [ -n "$WWW_CERT" ]; then
            az containerapp hostname bind --name $APP --resource-group $RG --hostname "www.$DOMAIN" --certificate "$WWW_CERT" || true
            echo "  Bound www.$DOMAIN"
          else
            echo "  Warning: WWW cert not ready — re-run this workflow after DNS propagates"
          fi

          echo "=== Done ==="
          az containerapp hostname list --name $APP --resource-group $RG -o table
