name: Deploy Infrastructure

# ─── Required GitHub Secrets ─────────────────────────────────────────────────
# AZURE_CREDENTIALS          — Service principal JSON (az ad sp create-for-rbac)
# AZURE_RESOURCE_GROUP       — Target resource group name
# POSTGRES_ADMIN_PASSWORD    — PostgreSQL admin password
# SESSION_SECRET             — iron-session encryption key (openssl rand -base64 32)
#
# ─── Required GitHub Variables (Settings → Secrets and variables → Variables) ─
# DOMAIN_NAME                — Custom domain (e.g. lezhiweng.com)
# STORAGE_ACCOUNT_NAME       — Globally unique, 3-24 lowercase alphanumeric
# SITE_URL                   — Public URL (e.g. https://lezhiweng.com)
# ALERT_EMAIL                — Email for Azure Monitor alert notifications
# ─────────────────────────────────────────────────────────────────────────────

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - what-if

jobs:
  infra:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep (what-if)
        if: inputs.action == 'what-if'
        run: |
          az deployment group what-if \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --template-file infra/main.bicep \
            --parameters \
              domainName='${{ vars.DOMAIN_NAME }}' \
              postgresAdminLogin='pgadmin' \
              postgresAdminPassword='${{ secrets.POSTGRES_ADMIN_PASSWORD }}' \
              sessionSecret='${{ secrets.SESSION_SECRET }}' \
              storageAccountName='${{ vars.STORAGE_ACCOUNT_NAME }}' \
              siteUrl='${{ vars.SITE_URL }}' \
              alertEmail='${{ vars.ALERT_EMAIL }}'

      - name: Deploy Bicep
        if: inputs.action == 'deploy'
        run: |
          az deployment group create \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --template-file infra/main.bicep \
            --parameters \
              domainName='${{ vars.DOMAIN_NAME }}' \
              postgresAdminLogin='pgadmin' \
              postgresAdminPassword='${{ secrets.POSTGRES_ADMIN_PASSWORD }}' \
              sessionSecret='${{ secrets.SESSION_SECRET }}' \
              storageAccountName='${{ vars.STORAGE_ACCOUNT_NAME }}' \
              siteUrl='${{ vars.SITE_URL }}' \
              alertEmail='${{ vars.ALERT_EMAIL }}' \
            --verbose

      - name: Show outputs
        if: inputs.action == 'deploy'
        run: |
          az deployment group show \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name main \
            --query properties.outputs
